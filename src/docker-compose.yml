version: "3.9"

services:
  # ---------- Servidor de referÃªncia ----------
  ref:
    build: .
    command: python src/ref/main.py
    ports:
      - "6000:6000"
    environment:
      - PERSIST_DIR=/app/data
    volumes:
      - ref_data:/app/data

  # ---------- Broker (JavaScript / Node.js) ----------
  broker:
    build: .
    command: node src/broker/main.js
    environment:
      - ROUTER_ADDR=tcp://*:5555
      - DEALER_ADDR=tcp://*:5556
    depends_on:
      - proxy

  # ---------- Proxy (Go) ----------
  proxy:
    build: .
    command: go run ./src/proxy_go/main.go
    environment:
      - XSUB_ADDR=tcp://*:5557
      - XPUB_ADDR=tcp://*:5558
    depends_on:
      - ref

  # ---------- Servidor (Python) ----------
  server:
    build: .
    command: python src/server/main.py
    environment:
      - BROKER_ENDPOINT=tcp://broker:5556
      - PROXY_XSUB=tcp://proxy:5557
      - PROXY_XPUB=tcp://proxy:5558        # ðŸ”¹ necessÃ¡rio para ouvir o tÃ³pico 'replica'
      - REF_HOST=ref
      - REF_PORT=6000
      - PERSIST_DIR=/app/data
      - SERVER_NAME=server
    volumes:
      - server_data:/app/data
    depends_on:
      - broker
      - proxy
      - ref
    deploy:
      replicas: 3                           # ðŸ”¹ 3 rÃ©plicas de servidores (parte 5)

  # ---------- Cliente automÃ¡tico ----------
  client_auto:
    build: .
    command: python src/client/main.py
    environment:
      - AUTO_CLIENT=1
      - BROKER_REQ=tcp://broker:5555
      - PROXY_XPUB=tcp://proxy:5558
    depends_on:
      - broker
      - proxy
      - server
    deploy:
      replicas: 2

volumes:
  server_data:
  ref_data:
